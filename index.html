<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Benestar üí´</title>

  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="Benestar">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Poppins", sans-serif;
      color: #222;
      background: url("images/background.png") center/cover no-repeat fixed;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      text-align: center;
    }

    header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      padding: 14px 18px;
      background-color: rgba(255, 255, 255, 0.55);
      border-radius: 0 0 15px 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      backdrop-filter: blur(8px);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 10;
    }

    .menu-btn {
      font-size: 1rem;
      padding: 6px 12px;
      border: none;
      background: none;
      cursor: pointer;
      border-radius: 8px;
      color: #333;
      transition: all 0.2s ease;
    }

    .menu-btn.active {
      font-weight: bold;
      color: #2e7d32;
      background-color: rgba(46,125,50,0.1);
    }

    label {
      font-size: 0.95rem;
      color: #333;
    }

    select {
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      padding: 5px 8px;
      background-color: white;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }

    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 80px;
      padding: 0 10px;
    }

    h2 {
      font-size: 3rem;
      color: #6ad76a;
      font-weight: 600;
      margin-bottom: 0.5em;
    }

    /* üì± iPhone and small phones */
    @media (max-width: 480px) {
      header {
        gap: 8px;
        padding: 10px;
        border-radius: 0 0 10px 10px;
        background-color: rgba(255,255,255,0.45);
      }

      .menu-btn {
        font-size: 0.9rem;
        padding: 5px 10px;
      }

      label, select {
        font-size: 0.85rem;
      }

      h2 {
        font-size: 1.9rem;
        margin-top: 30px;
      }
    }

    /* üì± Medium devices like iPads */
    @media (min-width: 481px) and (max-width: 1024px) {
      header {
        gap: 10px;
        padding: 12px;
        background-color: rgba(255,255,255,0.5);
      }

      .menu-btn {
        font-size: 1rem;
      }

      label, select {
        font-size: 0.9rem;
      }

      h2 {
        font-size: 2.4rem;
      }
    }

    /* üñ• Desktop large screens */
    @media (min-width: 1025px) {
      header {
        gap: 18px;
        padding: 16px 20px;
        background-color: rgba(255,255,255,0.6);
      }

      .menu-btn {
        font-size: 1.05rem;
      }

      label, select {
        font-size: 1rem;
      }

      h2 {
        font-size: 3rem;
      }
    }
  </style> 



</head>

<body>
  <header>
    <button class="menu-btn active" id="btnBenestar">Benestar</button>
    <button class="menu-btn" id="btnForca">For√ßa</button>
    <button class="menu-btn" id="btnPau">Pau</button>
    <label for="freqSelect">Frequ√®ncia</label>
    <select id="freqSelect">
      <option value="5">5 min</option>
      <option value="10">10 min</option>
      <option value="30">30 min</option>
      <option value="60">1 h</option>
      <option value="120">2 h</option>
      <option value="180">3 h</option>
      <option value="360">6 h</option>
      <option value="720">12 h</option>
    </select>
  </header>

  <main>
    <h2 id="message">M‚Äôestim</h2>
  </main>

  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-messaging-compat.js"></script>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyARM97493F50pd_QXhR6vRKIn897Q9yKQc",
      authDomain: "benestarpwa.firebaseapp.com",
      projectId: "benestarpwa",
      storageBucket: "benestarpwa.appspot.com",
      messagingSenderId: "487141570676",
      appId: "1:487141570676:web:83af17edc0d0d0b6b5b921"
    };

    // === Initialize Firebase ===
    firebase.initializeApp(firebaseConfig);

    // === Register service worker and initialize messaging ===
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("/firebase-messaging-sw.js") // ‚úÖ absolute root path for Firebase Hosting
        .then(async (registration) => {
          console.log("‚úÖ Service Worker registered:", registration);

          const messaging = firebase.messaging();
          messaging.useServiceWorker(registration);

          // Ask for permission once after registration
          if (Notification.permission === "default") {
            try {
              const permission = await Notification.requestPermission();
              console.log("üîî Notification permission:", permission);

              if (permission === "granted") {
                const token = await messaging.getToken({
                  vapidKey:
                    "BCmbjjP84nLgeIpyqqhfy58e32dVpmnCn0o7-rAWHIPgDBH6rCFp95lU1nvETH94eMoPbcUZlQzuVWzHs9JZX9s",
                  serviceWorkerRegistration: registration
                });
                console.log("‚úÖ FCM token:", token);
                // Optionally send it to your backend here
              }
            } catch (err) {
              console.error("‚ùå Permission request failed:", err);
            }
          } else {
            console.log("üîî Notification permission already set:", Notification.permission);
          }
        })
        .catch((err) => console.error("‚ùå Service Worker registration failed:", err));
    }



    // Messages per theme
    const messages = {
      benestar: [
        "M‚Äôestim", "M‚Äôestimen", "Som una afortunada de la vida",
        "Som agra√Øda", "Som feli√ß", "Som lliure"
      ],
      forca: [
        "Confia en la vida", "Confia en el proc√©s", "Tot du el seu temps",
        "Vas fent passes", "Vas progressant", "Vas avan√ßant"
      ],
      pau: [
        "Creu en el cam√≠", "Ho est√†s fent molt b√©", "Respira",
        "El progr√©s es fa caminant", "Vas b√©", "Paci√®ncia"
      ]
    };

    let currentTheme = "benestar";
    let currentIndex = 0;
    let intervalMinutes = 10;
    let intervalId = null;

    const messageEl = document.getElementById("message");
    const freqSelect = document.getElementById("freqSelect");

    // Button handlers
    document.getElementById("btnBenestar").onclick = () => setTheme("benestar");
    document.getElementById("btnForca").onclick = () => setTheme("forca");
    document.getElementById("btnPau").onclick = () => setTheme("pau");

    freqSelect.addEventListener("change", () => {
      intervalMinutes = parseInt(freqSelect.value);
      restartLoop();
    });

    function setTheme(theme) {
      currentTheme = theme;
      currentIndex = 0;
      document.querySelectorAll(".menu-btn").forEach(b => b.classList.remove("active"));
      document.getElementById("btn" + capitalize(theme)).classList.add("active");
      updateMessage();
      restartLoop();
    }

    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function updateMessage() {
      const msgs = messages[currentTheme];
      messageEl.textContent = msgs[currentIndex];
      currentIndex = (currentIndex + 1) % msgs.length;
    }

    function restartLoop() {
      if (intervalId) clearInterval(intervalId);

      // Immediately sync display and notification
      updateMessage(true);

      intervalId = setInterval(() => {
        updateMessage(true);
      }, intervalMinutes * 60 * 1000);
    }

    // Update message (and optionally trigger notification)
    function updateMessage(triggerNotification = false) {
      const msgs = messages[currentTheme];
      messageEl.textContent = msgs[currentIndex];
      currentIndex = (currentIndex + 1) % msgs.length;

      if (triggerNotification) showNotification(msgs[(currentIndex - 1 + msgs.length) % msgs.length]);
    }

    // Notifications
    async function showNotification(msg) {
      if (Notification.permission !== "granted") return;

      try {
        new Notification("üí´ Benestar üåø", {  // üëà small change here
          body: msg,
          icon: "icon-192.png"
        });
      } catch (err) {
        console.error("Notification error:", err);
      }
    }


    // === Register token + user frequency ===
    async function saveUserSettings(token, frequency) {
      try {
        await fetch("https://us-central1-benestarpwa.cloudfunctions.net/registerUser", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, frequency })
        });
        console.log("‚úÖ User settings saved:", frequency);
      } catch (err) {
        console.error("‚ùå Failed to save user settings:", err);
      }
    }

    // === Register Service Worker + Request Notification Permission ===
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker
        .register("./firebase-messaging-sw.js", { scope: "./" })
        .then(async (registration) => {
          console.log("‚úÖ Service Worker registered:", registration);

          // Initialize Firebase messaging bound to this SW
          const messaging = firebase.messaging();
          messaging.useServiceWorker(registration);

          // Ask for permission *after* SW is ready
          if (Notification.permission === "default") {
            const permission = await Notification.requestPermission();
            console.log("üîî Permission result:", permission);
          }

          // If granted, get token and save settings
          if (Notification.permission === "granted") {
            const token = await messaging.getToken({
              vapidKey: "BCmbjjP84nLgeIpyqqhfy58e32dVpmnCn0o7-rAWHIPgDBH6rCFp95lU1nvETH94eMoPbcUZlQzuVWzHs9JZX9s"
            });

            console.log("‚úÖ FCM Token:", token);
            const freq = parseInt(document.getElementById("freqSelect").value);
            await saveUserSettings(token, freq);
          }

          updateMessage();
          restartLoop();
        })
        .catch((err) => console.error("‚ùå Service Worker registration failed:", err));
    }


  </script>

  <script>
    // === Dynamic layout adjustment ===
    function adjustLayout() {
      const w = window.innerWidth;
      const header = document.querySelector("header");
      const buttons = document.querySelectorAll(".menu-btn");
      const label = document.querySelector("label");
      const select = document.querySelector("select");
      const msg = document.getElementById("message");

      if (w <= 480) {
        // üì± Mobile layout
        header.style.gap = "8px";
        header.style.padding = "8px 6px";
        header.style.borderRadius = "0 0 10px 10px";
        buttons.forEach(b => b.style.fontSize = "0.9rem");
        label.style.fontSize = "0.8rem";
        select.style.fontSize = "0.8rem";
        msg.style.fontSize = "1.8rem";
      } 
      else if (w <= 1024) {
        // üíª Tablet layout
        header.style.gap = "10px";
        header.style.padding = "10px";
        buttons.forEach(b => b.style.fontSize = "1rem");
        label.style.fontSize = "0.9rem";
        select.style.fontSize = "0.9rem";
        msg.style.fontSize = "2.2rem";
      } 
      else {
        // üñ• Desktop layout
        header.style.gap = "15px";
        header.style.padding = "14px";
        buttons.forEach(b => b.style.fontSize = "1.1rem");
        label.style.fontSize = "1rem";
        select.style.fontSize = "1rem";
        msg.style.fontSize = "3rem";
      }
    }

    // Call once on load and again when resizing
    window.addEventListener("load", adjustLayout);
    window.addEventListener("resize", adjustLayout);
  </script>

  <script>
    // Swipe navigation setup
    let touchStartX = 0;
    let touchEndX = 0;

    // Detect touch start
    document.addEventListener("touchstart", (e) => {
      touchStartX = e.changedTouches[0].screenX;
    });

    // Detect touch end and direction
    document.addEventListener("touchend", (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipeGesture();
    });

    function handleSwipeGesture() {
      const swipeThreshold = 50; // Minimum distance in px to count as swipe
      const diff = touchEndX - touchStartX;

      if (Math.abs(diff) < swipeThreshold) return; // Ignore small touches

      if (diff > 0) {
        // Swipe right ‚Üí previous message
        showPreviousMessage();
      } else {
        // Swipe left ‚Üí next message
        showNextMessage();
      }
    }

    // Keyboard support for desktop users
    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowRight") showNextMessage();
      if (e.key === "ArrowLeft") showPreviousMessage();
    });

    function showNextMessage() {
      const msgs = messages[currentTheme];
      currentIndex = (currentIndex + 1) % msgs.length;
      messageEl.textContent = msgs[currentIndex];
    }

    function showPreviousMessage() {
      const msgs = messages[currentTheme];
      currentIndex = (currentIndex - 1 + msgs.length) % msgs.length;
      messageEl.textContent = msgs[currentIndex];
    }
  </script>


</body>
</html>


