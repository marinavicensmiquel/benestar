name: Send Benestar notifications

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Generate OAuth access token
        id: generate_token
        shell: bash
        run: |
          echo '${{ secrets.FCM_SERVICE_KEY }}' > key.json
          echo "import json, time, jwt, requests" > gen_token.py
          echo "with open('key.json') as f:" >> gen_token.py
          echo "    key = json.load(f)" >> gen_token.py
          echo "now = int(time.time())" >> gen_token.py
          echo "payload = {" >> gen_token.py
          echo "    'iss': key['client_email']," >> gen_token.py
          echo "    'scope': 'https://www.googleapis.com/auth/firebase.messaging'," >> gen_token.py
          echo "    'aud': key['token_uri']," >> gen_token.py
          echo "    'iat': now," >> gen_token.py
          echo "    'exp': now + 3600" >> gen_token.py
          echo "}" >> gen_token.py
          echo "jwt_token = jwt.encode(payload, key['private_key'], algorithm='RS256')" >> gen_token.py
          echo "r = requests.post('https://oauth2.googleapis.com/token', data={'grant_type':'urn:ietf:params:oauth:grant-type:jwt-bearer','assertion':jwt_token})" >> gen_token.py
          echo "token = r.json()['access_token']" >> gen_token.py
          echo "open('access_token.txt','w').write(token)" >> gen_token.py

          python3 gen_token.py
          echo "token=$(cat access_token.txt)" >> $GITHUB_OUTPUT

      - name: Send Benestar notification
        run: |
          TOKEN=${{ steps.generate_token.outputs.token }}
          curl -X POST "https://fcm.googleapis.com/v1/projects/benestarpwa/messages:send" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json; UTF-8" \
            -d '{
              "message": {
                "topic": "all",
                "notification": {
                  "title": "ðŸ’š Benestar",
                  "body": "Itâ€™s time for your wellbeing check"
                }
              }
            }'
